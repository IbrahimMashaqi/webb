<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Sale - Up to 40% Off - Stilleto</title>

    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"
    />
    <link rel="stylesheet" href="css/index.css" />

    <style>
      .sale-banner {
        background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
        color: white;
        padding: 80px 40px;
        text-align: center;
        position: relative;
        overflow: hidden;
      }

      .sale-banner::before {
        content: "SALE";
        position: absolute;
        font-size: 200px;
        font-weight: 900;
        opacity: 0.1;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
      }

      .sale-badge {
        display: inline-block;
        padding: 12px 30px;
        background: rgba(255, 255, 255, 0.3);
        border-radius: 30px;
        font-size: 14px;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 3px;
        margin-bottom: 20px;
        animation: pulse 2s infinite;
        position: relative;
        z-index: 1;
      }

      @keyframes pulse {
        0%,
        100% {
          transform: scale(1);
        }
        50% {
          transform: scale(1.05);
        }
      }

      .sale-banner h1 {
        font-size: 64px;
        font-weight: 900;
        margin: 0 0 15px 0;
        letter-spacing: -2px;
        position: relative;
        z-index: 1;
      }

      .sale-banner p {
        font-size: 20px;
        margin: 0 0 30px 0;
        opacity: 0.95;
        position: relative;
        z-index: 1;
      }

      .countdown-timer-sale {
        display: flex;
        justify-content: center;
        gap: 20px;
        margin-top: 30px;
        position: relative;
        z-index: 1;
      }

      .time-box {
        background: rgba(255, 255, 255, 0.2);
        backdrop-filter: blur(10px);
        padding: 20px;
        border-radius: 15px;
        min-width: 90px;
      }

      .time-box .time-number {
        font-size: 36px;
        font-weight: 900;
        display: block;
      }

      .time-box .time-label {
        font-size: 12px;
        text-transform: uppercase;
        letter-spacing: 1px;
        opacity: 0.9;
      }

      .discount-badge {
        position: absolute;
        top: 15px;
        right: 15px;
        background: #e74c3c;
        color: white;
        padding: 8px 16px;
        border-radius: 25px;
        font-weight: 700;
        font-size: 14px;
        z-index: 10;
        box-shadow: 0 4px 15px rgba(231, 76, 60, 0.4);
      }

      .original-price {
        text-decoration: line-through;
        color: #95a5a6;
        font-size: 16px;
        margin-right: 10px;
      }

      .sale-price {
        color: #e74c3c;
        font-size: 24px;
        font-weight: 700;
      }

      .savings-text {
        color: #27ae60;
        font-size: 14px;
        font-weight: 600;
        margin-top: 5px;
      }

      .sale-empty {
        text-align: center;
        padding: 60px 20px;
        color: #666;
        grid-column: 1 / -1;
      }

      .main-content {
        max-width: 1400px;
        margin: 30px auto;
        padding: 0 40px;
        display: flex;
        gap: 30px;
      }

      .filters-sidebar {
        width: 260px;
        flex-shrink: 0;
        background: #f8f9fa;
        padding: 25px;
        border-radius: 12px;
        height: fit-content;
        position: sticky;
        top: 20px;
      }

      .filters-sidebar h3 {
        margin: 0 0 20px 0;
        font-size: 18px;
        font-weight: 700;
        color: #2c3e50;
        padding-bottom: 15px;
        border-bottom: 2px solid #e74c3c;
      }

      .filter-group {
        margin-bottom: 25px;
      }

      .filter-group-title {
        font-weight: 600;
        font-size: 14px;
        color: #34495e;
        margin-bottom: 12px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }

      .filter-group input[type="range"] {
        width: 100%;
        margin: 10px 0;
        accent-color: #e74c3c;
      }

      .price-display {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-top: 8px;
        font-size: 14px;
        color: #7f8c8d;
      }

      .price-display .current-price {
        font-weight: 700;
        color: #e74c3c;
        font-size: 16px;
      }

      .filter-group label {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 8px 0;
        cursor: pointer;
        font-size: 14px;
        color: #2c3e50;
        transition: color 0.3s;
      }

      .filter-group label:hover {
        color: #e74c3c;
      }

      .filter-group input[type="checkbox"] {
        width: 18px;
        height: 18px;
        cursor: pointer;
        accent-color: #e74c3c;
      }

      .products-content {
        flex: 1;
        min-width: 0;
      }

      .products-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 25px;
      }

      .products-count {
        font-size: 14px;
        color: #7f8c8d;
      }

      @media (max-width: 968px) {
        .main-content {
          flex-direction: column;
        }

        .filters-sidebar {
          width: 100%;
          position: static;
        }
      }
    </style>
  </head>

  <body>
    <div class="header-decoration"></div>

    <div class="header">
      <div class="header-left">
        <a href="home.html"><img src="heels/logo1.png" alt="Logo" /></a>
      </div>
      <div class="header-right">
        <a href="home.html">Home</a>
        <a href="heels.html">Heels</a>
        <a href="bags.html">Bags</a>
        <a href="made_to_order.html">Bespoke</a>
        <a href="new-arrivals.html">New</a>
        <a href="sale.html" class="active">Sale</a>

        <a href="track_order.html"
          ><i class="fa-solid fa-truck"></i> <span>Track Order</span></a
        >
        <a href="store_locator.html"
          ><i class="fa-solid fa-location-dot"></i>
          <span>Store Locator</span></a
        >
        <a href="contact.html"
          ><i class="fa-solid fa-phone"></i> <span>Contact</span></a
        >

        <div class="icon-badge" onclick="toggleCart()">
          <i class="fa-solid fa-bag-shopping"></i>
          <span class="badge-pill" id="cart-count">0</span>
        </div>

        <div class="icon-badge" onclick="viewWishlist()">
          <i class="fa-solid fa-heart"></i>
          <span class="badge-pill" id="wishlist-count">0</span>
        </div>

        <a href="login.html" id="user-link"
          ><i class="fa-solid fa-user"></i> <span>Login</span></a
        >
        <div class="theme-toggle"><i class="fa-solid fa-moon"></i></div>
        <button class="toggle-sidebar">
          <i class="fa-solid fa-bars"></i>
        </button>
      </div>
    </div>

    <!-- SALE BANNER -->
    <div class="sale-banner">
      <span class="sale-badge">üî• Limited Time Offer</span>
      <h1>Up to 40% OFF</h1>
      <p>Amazing deals on luxury heels and bags</p>

      <div class="countdown-timer-sale">
        <div class="time-box">
          <span class="time-number" id="sale-days">00</span>
          <span class="time-label">Days</span>
        </div>
        <div class="time-box">
          <span class="time-number" id="sale-hours">00</span>
          <span class="time-label">Hours</span>
        </div>
        <div class="time-box">
          <span class="time-number" id="sale-minutes">00</span>
          <span class="time-label">Minutes</span>
        </div>
        <div class="time-box">
          <span class="time-number" id="sale-seconds">00</span>
          <span class="time-label">Seconds</span>
        </div>
      </div>
    </div>

    <!-- FILTERS & PRODUCTS -->
    <div class="main-content">
      <!-- LEFT SIDEBAR FILTERS -->
      <aside class="filters-sidebar">
        <h3>üîç Filters</h3>

        <div class="filter-group">
          <div class="filter-group-title">Price Range</div>
          <input type="range" id="priceFilter" min="0" max="1000" value="1000" step="10">
          <div class="price-display">
            <span>Max:</span>
            <span class="current-price">NIS <span id="priceValue">1000</span></span>
          </div>
        </div>

        <div class="filter-group">
          <div class="filter-group-title">Category</div>
          <label>
            <input type="checkbox" class="filter-category" value="Heels">
            <span> Heels</span>
          </label>
          <label>
            <input type="checkbox" class="filter-category" value="Bags">
            <span> Bags</span>
          </label>
          <label>
            <input type="checkbox" class="filter-category" value="All">
            <span> All</span>
          </label>
        </div>
      </aside>

      <!-- RIGHT PRODUCTS AREA -->
      <div class="products-content">
        <div class="products-header">
          <div class="products-count">
            <span id="productCount">0</span> Products on Sale
          </div>
        </div>
        
        <div class="products" id="saleProducts" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 30px;"></div>
      </div>
    </div>

    <!-- CART SIDEBAR -->
    <div id="cartSidebar" class="cart-sidebar">
      <div class="cart-header">
        <h2>MY BAG (<span id="cart-items-count">0</span>)</h2>
        <button class="cart-close" onclick="toggleCart()">&times;</button>
      </div>
      <div class="cart-items" id="cartItemsContainer"></div>
      <div class="cart-footer">
        <div class="cart-subtotal">
          <span>SUBTOTAL</span>
          <span class="subtotal-amount" id="cartSubtotal">NIS 0.00</span>
        </div>
        <button class="checkout-btn" onclick="proceedToCheckout()">
          CHECKOUT
        </button>
        <button class="view-bag-btn" onclick="viewBag()">VIEW BAG</button>
      </div>
    </div>

    <div id="cartOverlay" class="cart-overlay" onclick="toggleCart()"></div>

    <footer>
      <p>&copy; 2025 Stilleto | All rights reserved.</p>
      <p>
        <a href="#">Privacy Policy</a> | <a href="#">Terms of Service</a> |
        <a href="#">Help</a>
      </p>
    </footer>

    <script src="js/auth.js"></script>
    <script src="js/cart.js"></script>
    <script src="js/global-functions.js"></script>

    <script>
      // ---------- helpers ----------
      function escapeHtml(s) {
        return String(s ?? "").replace(/[&<>"']/g, (c) => {
          return { "&": "&amp;", "<": "&lt;", ">": "&gt;", '"': "&quot;", "'": "&#39;" }[c];
        });
      }
      function money(n) {
        return Number(n || 0).toFixed(2);
      }

      // ---------- load sale products ----------
      fetch("api/sale.php")
        .then((res) => res.json())
        .then((data) => renderSale(Array.isArray(data) ? data : []))
        .catch((err) => {
          console.error(err);
          renderSale([]);
        });

      function renderSale(products) {
        const container = document.getElementById("saleProducts");
        const countDisplay = document.getElementById("productCount");
        container.innerHTML = "";

        if (!products.length) {
          container.innerHTML = `
            <div class="sale-empty">
              <i class="fa-solid fa-tags" style="font-size:40px;margin-bottom:10px;"></i>
              <h3 style="margin:0 0 8px;">No sale products right now</h3>
              <p style="margin:0;">Ask admin to set <b>is_on_sale=1</b> and <b>sale_percentage</b> for products.</p>
            </div>
          `;
          countDisplay.textContent = "0";
          return;
        }

        countDisplay.textContent = products.length;

        products.forEach((p) => {
          const title = escapeHtml(p.title);
          const desc = escapeHtml(p.description);
          const img = escapeHtml(p.image);
          const percent = Number(p.discount_percentage || 0);
          const original = Number(p.original_price || 0);
          const sale = Number(p.sale_price || 0);
          const save = Math.max(0, original - sale);
          const cat = escapeHtml(p.category);

          container.insertAdjacentHTML(
            "beforeend",
            `
            <div class="product" 
                 data-id="${p.id}"
                 data-category="${cat}"
                 data-price="${sale}">
              <div class="discount-badge">-${percent}%</div>
              <i class="fa-solid fa-heart wishlist"></i>

              <img src="${img}" alt="${title}" />

              <h3>${title}</h3>

              <div style="display:flex;align-items:center;justify-content:center;gap:10px;margin:10px 0;">
                <span class="original-price">NIS ${money(original)}</span>
                <span class="sale-price">NIS ${money(sale)}</span>
              </div>

              <div class="savings-text">Save NIS ${money(save)}</div>

              <div class="rating">‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ</div>

              <div class="actions">
                <button class="btn-add-cart-sale">Add to Cart</button>

                <button
                  class="quick-view-btn"
                  data-image="${img}"
                  data-title="${title}"
                  data-description="${desc}"
                  data-sizes="${cat}"
                  data-status="On Sale"
                  data-features="Limited Offer"
                >
                  Quick View
                </button>
              </div>
            </div>
          `
          );
        });

        // Mark products as loaded and enable filters
        productsLoaded = true;
      }

      // ---------- event delegation ----------
      document.addEventListener("click", (e) => {
        // wishlist
        if (e.target.classList.contains("wishlist")) {
          e.stopPropagation();
          e.target.classList.toggle("active");
          e.target.style.color = e.target.classList.contains("active") ? "#e74c3c" : "";
          return;
        }

        // add to cart
        if (e.target.classList.contains("btn-add-cart-sale")) {
          const productEl = e.target.closest(".product");
          const title = productEl.querySelector("h3").textContent;
          const img = productEl.querySelector("img").getAttribute("src");
          const salePrice = productEl.querySelector(".sale-price").textContent;

          addToCartGlobal({
            title: title,
            price: salePrice,
            image: img,
            size: "Default",
            quantity: 1,
          });

          e.target.textContent = "‚úì Added!";
          e.target.style.background = "#27ae60";
          setTimeout(() => {
            e.target.textContent = "Add to Cart";
            e.target.style.background = "";
          }, 1500);

          return;
        }
      });

      // ---------- FILTERS ----------
      const priceFilter = document.getElementById("priceFilter");
      const priceValue = document.getElementById("priceValue");
      const categoryChecks = document.querySelectorAll(".filter-category");

      // Wait for products to load before attaching filter events
      let productsLoaded = false;

      priceFilter?.addEventListener("input", (e) => {
        priceValue.textContent = e.target.value;
        if (productsLoaded) applyFilters();
      });

      categoryChecks.forEach(c => c.addEventListener("change", () => {
        if (productsLoaded) applyFilters();
      }));

      function applyFilters() {
        const maxPrice = Number(priceFilter.value);
        const checkedBoxes = [...categoryChecks].filter(c => c.checked);
        const selectedCategories = checkedBoxes.map(c => c.value);
        
        let visibleCount = 0;

        document.querySelectorAll(".product").forEach(p => {
          const price = Number(p.dataset.price);
          const productCategory = p.dataset.category.trim();

          // Check price filter
          let matchesPrice = price <= maxPrice;
          
          // Check category filter
          // If NO categories selected, show all
          // If categories ARE selected, only show products that match
          let matchesCategory = true;
          if (selectedCategories.length > 0) {
            matchesCategory = selectedCategories.includes(productCategory);
          }

          // Product is visible if it matches BOTH price AND category
          let show = matchesPrice && matchesCategory;

          p.style.display = show ? "" : "none";
          if (show) visibleCount++;
        });

        document.getElementById("productCount").textContent = visibleCount;
        
        // Debug: see what's happening
        console.log("Filter Debug:", {
          selectedCategories,
          maxPrice,
          visibleCount,
          allProducts: document.querySelectorAll(".product").length
        });
      }

      // ---------- countdown timer ----------
      function updateSaleCountdown() {
        let endDate = localStorage.getItem("saleEndDate");

        if (!endDate) {
          const newEndDate = new Date();
          newEndDate.setDate(newEndDate.getDate() + 3);
          endDate = newEndDate.getTime();
          localStorage.setItem("saleEndDate", endDate);
        } else {
          endDate = parseInt(endDate);
        }

        const now = new Date().getTime();
        const distance = endDate - now;

        if (distance < 0) {
          const newEndDate = new Date();
          newEndDate.setDate(newEndDate.getDate() + 3);
          localStorage.setItem("saleEndDate", newEndDate.getTime());
          updateSaleCountdown();
          return;
        }

        const days = Math.floor(distance / (1000 * 60 * 60 * 24));
        const hours = Math.floor(
          (distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60)
        );
        const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
        const seconds = Math.floor((distance % (1000 * 60)) / 1000);

        document.getElementById("sale-days").textContent = String(days).padStart(2, "0");
        document.getElementById("sale-hours").textContent = String(hours).padStart(2, "0");
        document.getElementById("sale-minutes").textContent = String(minutes).padStart(2, "0");
        document.getElementById("sale-seconds").textContent = String(seconds).padStart(2, "0");
      }

      setInterval(updateSaleCountdown, 1000);
      updateSaleCountdown();

      // ---------- theme toggle ----------
      document.querySelector(".theme-toggle").addEventListener("click", () => {
        document.body.classList.toggle("dark");
        const icon = document.querySelector(".theme-toggle i");
        icon.className = document.body.classList.contains("dark")
          ? "fa-solid fa-sun"
          : "fa-solid fa-moon";
      });
    </script>
  </body>
</html>